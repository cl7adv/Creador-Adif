<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Neon Log Master V4.4</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&family=Rajdhani:wght@400;600&display=swap" rel="stylesheet">
<style>
    :root {
        --bg-main: #020010;
        --neon-cyan: #00f6ff;
        --neon-magenta: #ff00ff;
        --neon-yellow: #ffe600;
        --neon-green: #00ff88;
        --text-main: #e6ffff;
    }

    body {
        margin: 0;
        font-family: 'Rajdhani', Arial, sans-serif;
        background: radial-gradient(circle at top, #051f33, var(--bg-main));
        color: var(--text-main);
        overflow: hidden;
    }

    /* Splash neon mejorado */
    #splash {
        position: fixed;
        inset: 0;
        background:
            radial-gradient(circle at 30% 20%, rgba(0, 246, 255, 0.15), transparent 50%),
            radial-gradient(circle at 70% 80%, rgba(255, 0, 255, 0.1), transparent 50%),
            radial-gradient(circle at 50% 50%, rgba(0, 255, 136, 0.05), transparent 60%),
            radial-gradient(circle, #050016 0%, #000 70%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 1;
        visibility: visible;
        transition: opacity 1.5s ease-in-out, visibility 1.5s;
    }

    #splash.hidden {
        opacity: 0;
        visibility: hidden;
    }

    .logo-container {
        text-align: center;
        margin-bottom: 40px;
        position: relative;
    }

    .main-title {
        font-family: 'Orbitron', Arial, sans-serif;
        letter-spacing: 0.3em;
        font-size: 4.2rem;
        font-weight: 700;
        color: var(--neon-cyan);
        text-shadow:
            0 0 10px var(--neon-cyan),
            0 0 20px var(--neon-cyan),
            0 0 40px var(--neon-cyan),
            0 0 80px var(--neon-cyan);
        animation: titleGlow 3s infinite alternate;
        margin-bottom: 10px;
        text-transform: uppercase;
    }

    .version {
        font-family: 'Orbitron', Arial, sans-serif;
        font-size: 1.8rem;
        color: var(--neon-magenta);
        text-shadow:
            0 0 5px var(--neon-magenta),
            0 0 15px var(--neon-magenta);
        letter-spacing: 0.2em;
        margin-bottom: 5px;
    }

    .subtitle {
        font-family: 'Orbitron', Arial, sans-serif;
        font-size: 1.3rem;
        color: var(--neon-yellow);
        text-shadow:
            0 0 5px var(--neon-yellow),
            0 0 15px rgba(255, 230, 0, 0.5);
        letter-spacing: 0.15em;
        margin-bottom: 30px;
        text-transform: uppercase;
    }

    .description {
        text-align: center;
        max-width: 600px;
        margin: 0 auto 40px;
        font-size: 1.2rem;
        color: #a0f0ff;
        line-height: 1.6;
        text-shadow: 0 0 10px rgba(160, 240, 255, 0.5);
        padding: 0 20px;
    }

    .description p {
        margin: 10px 0;
    }

    .access-btn {
        padding: 18px 50px;
        font-family: 'Orbitron', Arial, sans-serif;
        font-size: 1.4rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        background: linear-gradient(90deg, 
            rgba(0, 246, 255, 0.1), 
            rgba(255, 0, 255, 0.1), 
            rgba(0, 255, 136, 0.1));
        border: 2px solid var(--neon-cyan);
        border-radius: 50px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        margin-bottom: 50px;
        box-shadow:
            0 0 20px rgba(0, 246, 255, 0.5),
            0 0 40px rgba(255, 0, 255, 0.3),
            inset 0 0 20px rgba(0, 246, 255, 0.1);
    }

    .access-btn:hover {
        transform: scale(1.05);
        box-shadow:
            0 0 30px rgba(0, 246, 255, 0.8),
            0 0 60px rgba(255, 0, 255, 0.5),
            inset 0 0 30px rgba(0, 246, 255, 0.2);
        border-color: var(--neon-magenta);
    }

    .access-btn:active {
        transform: scale(0.98);
    }

    .access-btn::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, 
            var(--neon-cyan), 
            var(--neon-magenta), 
            var(--neon-green));
        border-radius: 52px;
        z-index: -1;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .access-btn:hover::before {
        opacity: 1;
    }

    .footer-copyright {
        position: absolute;
        bottom: 30px;
        text-align: center;
        width: 100%;
        font-family: 'Orbitron', Arial, sans-serif;
        font-size: 0.9rem;
        letter-spacing: 0.15em;
        color: var(--neon-green);
        text-shadow:
            0 0 5px var(--neon-green),
            0 0 15px rgba(0, 255, 136, 0.3);
    }

    .glow-dots {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }

    .glow-dot {
        position: absolute;
        width: 3px;
        height: 3px;
        background: var(--neon-cyan);
        border-radius: 50%;
        box-shadow: 0 0 10px 2px var(--neon-cyan);
        animation: float 15s infinite linear;
    }

    @keyframes titleGlow {
        0%, 100% {
            text-shadow:
                0 0 10px var(--neon-cyan),
                0 0 20px var(--neon-cyan),
                0 0 40px var(--neon-cyan),
                0 0 80px var(--neon-cyan);
        }
        50% {
            text-shadow:
                0 0 15px var(--neon-cyan),
                0 0 30px var(--neon-cyan),
                0 0 60px var(--neon-cyan),
                0 0 100px var(--neon-cyan);
        }
    }

    @keyframes float {
        0% {
            transform: translateY(0) translateX(0);
            opacity: 0;
        }
        10% {
            opacity: 1;
        }
        90% {
            opacity: 1;
        }
        100% {
            transform: translateY(-100vh) translateX(100px);
            opacity: 0;
        }
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 0.5;
        }
        50% {
            opacity: 1;
        }
    }

    /* Layout principal (oculto inicialmente) */
    #app {
        display: flex;
        height: 100vh;
        padding: 12px;
        box-sizing: border-box;
        gap: 10px;
        opacity: 0;
        transition: opacity 1s ease;
    }

    #app.visible {
        opacity: 1;
    }

    /* Resto del CSS permanece igual... */
    #left-panel {
        width: 340px;
        padding: 12px 12px 40px;
        box-sizing: border-box;
        border-right: 2px solid rgba(0, 246, 255, 0.6);
        background: radial-gradient(circle at top left, rgba(0, 246, 255, 0.15), rgba(0, 0, 0, 0.8));
        box-shadow:
            0 0 15px rgba(0, 246, 255, 0.3),
            inset 0 0 20px rgba(0, 0, 0, 0.8);
        border-radius: 8px;
    }
    #right-panel {
        flex: 1;
        padding: 12px;
        box-sizing: border-box;
        overflow-y: auto;
        background: radial-gradient(circle at top right, rgba(255, 0, 255, 0.1), rgba(0, 0, 0, 0.9));
        border-radius: 8px;
        box-shadow:
            0 0 15px rgba(255, 0, 255, 0.2),
            inset 0 0 20px rgba(0, 0, 0, 0.8);
    }

    h2, h3 {
        margin: 4px 0 10px;
        font-family: 'Orbitron', Arial, sans-serif;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--neon-cyan);
        text-shadow:
            0 0 4px var(--neon-cyan),
            0 0 12px var(--neon-cyan);
        font-size: 1rem;
    }

    label {
        display: block;
        margin-top: 5px;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--neon-yellow);
    }
    input, select, textarea {
        width: 100%;
        box-sizing: border-box;
        margin-top: 2px;
        padding: 5px 7px;
        border-radius: 4px;
        border: 1px solid rgba(0, 246, 255, 0.6);
        background: rgba(0, 0, 0, 0.85);
        color: var(--text-main);
        font-size: 0.85rem;
        font-family: 'Rajdhani', Arial, sans-serif;
        outline: none;
        box-shadow: 0 0 6px rgba(0, 246, 255, 0.2);
    }
    input:focus, select:focus, textarea:focus {
        border-color: var(--neon-magenta);
        box-shadow:
            0 0 5px var(--neon-magenta),
            0 0 15px rgba(255, 0, 255, 0.6);
    }
    textarea {
        resize: vertical;
        min-height: 40px;
    }

    .inline-row {
        display: flex;
        gap: 6px;
    }
    .inline-row > div {
        flex: 1;
    }

    .btn {
        margin-top: 8px;
        padding: 6px 10px;
        border-radius: 16px;
        border: 1px solid var(--neon-cyan);
        background: linear-gradient(90deg, #021726, #02263c);
        color: var(--text-main);
        cursor: pointer;
        font-size: 0.8rem;
        font-family: 'Rajdhani', Arial, sans-serif;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        text-shadow: 0 0 4px var(--neon-cyan);
        box-shadow:
            0 0 8px rgba(0, 246, 255, 0.4),
            0 0 16px rgba(0, 246, 255, 0.2);
        transition: transform 0.1s, box-shadow 0.1s, border-color 0.1s;
    }
    .btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow:
            0 0 10px rgba(0, 246, 255, 0.8),
            0 0 20px rgba(0, 246, 255, 0.5);
    }
    .btn-danger {
        border-color: #ff3b3b;
        background: linear-gradient(90deg, #260202, #3c0202);
        text-shadow: 0 0 4px #ff3b3b;
        box-shadow:
            0 0 8px rgba(255, 59, 59, 0.6),
            0 0 16px rgba(255, 59, 59, 0.3);
    }
    .btn-secondary {
        border-color: var(--neon-magenta);
        background: linear-gradient(90deg, #26022b, #3e0447);
        text-shadow: 0 0 4px var(--neon-magenta);
        box-shadow:
            0 0 8px rgba(255, 0, 255, 0.6),
            0 0 16px rgba(255, 0, 255, 0.3);
    }
    .btn:disabled {
        opacity: 0.35;
        cursor: not-allowed;
        box-shadow: none;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
    }
    th, td {
        border-bottom: 1px solid #053043;
        padding: 4px 3px;
        text-align: left;
        white-space: nowrap;
    }
    th {
        position: sticky;
        top: 0;
        background: rgba(2, 18, 32, 0.98);
        color: var(--neon-cyan);
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        z-index: 1;
    }
    tr:nth-child(even) {
        background: rgba(0, 10, 20, 0.7);
    }
    tr.selected-row {
        background: linear-gradient(90deg, rgba(0, 246, 255, 0.25), rgba(0, 0, 0, 0.8));
    }
    td button {
        font-size: 0.7rem;
    }

    .small {
        font-size: 0.7rem;
        color: var(--neon-cyan);
        opacity: 0.85;
    }
    .footer {
        position: fixed;
        bottom: 4px;
        right: 8px;
        font-size: 0.74rem;
        color: var(--neon-cyan);
        font-family: 'Orbitron', Arial, sans-serif;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        text-shadow:
            0 0 4px var(--neon-cyan),
            0 0 12px var(--neon-cyan);
        pointer-events: none;
    }
</style>
</head>
<body>

<!-- Nueva portada -->
<div id="splash">
    <div class="logo-container">
        <h1 class="main-title">Neon Log Master</h1>
        <div class="version">V4.4 • Digital Station Log</div>
        <div class="subtitle">Sistema digital de registro QSO</div>
    </div>
    
    <div class="description">
        <p>Para uso de Radioaficionados</p>
    </div>
    
    <button class="access-btn" id="accessSystem">Acceder al Sistema</button>
    
    <div class="footer-copyright">
        © 2025-2026 • CL7ADV • Camagüey
    </div>
    
    <!-- Efecto de puntos luminosos -->
    <div class="glow-dots" id="glowDots"></div>
</div>

<!-- Aplicación principal -->
<div id="app">
    <!-- Panel izquierdo -->
    <div id="left-panel">
        <h2>Nuevo QSO</h2>

        <label>Tu indicativo</label>
        <input type="text" id="myCall" placeholder="CL7ADV">

        <label>Tu Gmail</label>
        <input type="email" id="myEmail" placeholder="tucorreo@gmail.com">
        <button class="btn btn-secondary" id="saveMyInfo">Guardar mis datos</button>

        <hr style="border-color: rgba(0, 246, 255, 0.3); margin: 8px 0;">

        <label>Indicativo trabajado</label>
        <input type="text" id="call" placeholder="EA1ABC">

        <div class="inline-row">
            <div>
                <label>Fecha (UTC)</label>
                <input type="date" id="date">
            </div>
            <div>
                <label>Hora (UTC)</label>
                <input type="text" id="time" placeholder="HHMM o HH:MM">
            </div>
        </div>

        <div class="inline-row">
            <div>
                <label>Banda</label>
                <select id="band">
                    <option value="">Selecciona banda</option>
                    <option>160m</option>
                    <option>80m</option>
                    <option>60m</option>
                    <option>40m</option>
                    <option>30m</option>
                    <option>20m</option>
                    <option>17m</option>
                    <option>15m</option>
                    <option>12m</option>
                    <option>10m</option>
                    <option>6m</option>
                    <option>2m</option>
                    <option>70cm</option>
                    <option>23cm</option>
                </select>
            </div>
            <div>
                <label>Modo</label>
                <select id="mode">
                    <option value="">Selecciona modo</option>
                    <option>CW</option>
                    <option>SSB</option>
                    <option>LSB</option>
                    <option>USB</option>
                    <option>AM</option>
                    <option>FM</option>   
                    <option>DV</option>
                    <option>FT8</option>
                    <option>FT4</option>
                    <option>RTTY</option>
                    <option>PSK31</option>
                    <option>JT65</option>
                    <option>JT9</option>
                    <option>OLIVIA</option>
                    <option>MFSK</option>
                    <option>FSK441</option>
                    <option>SSTV</option>
                    <option>OTHER</option>
                </select>
            </div>
        </div>

        <div class="inline-row">
            <div>
                <label>RST recibido</label>
                <input type="text" id="rstHis" placeholder="59, 579...">
            </div>
            <div>
                <label>Frecuencia (MHz, opc.)</label>
                <input type="text" id="freq" placeholder="14.074">
            </div>
        </div>

        <label>Comentarios (opcional)</label>
        <textarea id="comments"></textarea>

        <button class="btn" id="btnQRZ">Ir a QRZ.com</button>
        <button class="btn" id="btnAddQSO">Guardar QSO</button>
        <button class="btn btn-secondary" id="btnUpdateQSO" disabled>Actualizar QSO</button>
        <button class="btn btn-secondary" id="btnCancelEdit" disabled>Cancelar edición</button>

        <p class="small" id="status"></p>
    </div>

    <!-- Panel derecho -->
    <div id="right-panel">
        <h3>Libro de guardia</h3>

        <div style="margin-bottom:8px; display:flex; flex-wrap:wrap; gap:6px;">
            <button class="btn" id="btnDeleteSelected">Eliminar seleccionados</button>
            <button class="btn btn-danger" id="btnDeleteAll">Eliminar todos</button>
            <button class="btn btn-secondary" id="btnExportSelected">Exportar .ADI seleccionados</button>
            <button class="btn btn-secondary" id="btnExportAll">Exportar .ADI todos</button>
        </div>

        <table id="logTable">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>#</th>
                    <th>Indicativo</th>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Banda</th>
                    <th>Modo</th>
                    <th>RST</th>
                    <th>Frecuencia</th>
                    <th>Comentarios</th>
                    <th>Editar</th>
                    <th>Borrar</th>
                </tr>
            </thead>
            <tbody id="logBody">
            </tbody>
        </table>
    </div>
</div>

<div class="footer">
    &copy; CL7ADV
</div>

<script>
    // Generar puntos luminosos
    function createGlowDots() {
        const container = document.getElementById('glowDots');
        const dotCount = 30;
        
        for (let i = 0; i < dotCount; i++) {
            const dot = document.createElement('div');
            dot.className = 'glow-dot';
            
            // Posición aleatoria
            dot.style.left = Math.random() * 100 + '%';
            dot.style.top = Math.random() * 100 + '%';
            
            // Tamaño aleatorio
            const size = 2 + Math.random() * 4;
            dot.style.width = size + 'px';
            dot.style.height = size + 'px';
            
            // Color aleatorio
            const colors = ['#00f6ff', '#ff00ff', '#00ff88', '#ffe600'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            dot.style.backgroundColor = color;
            dot.style.boxShadow = `0 0 10px 2px ${color}`;
            
            // Animación aleatoria
            const duration = 10 + Math.random() * 20;
            const delay = Math.random() * 5;
            dot.style.animation = `float ${duration}s infinite linear ${delay}s`;
            
            container.appendChild(dot);
        }
    }

    // Función para acceder al sistema
    function accessSystem() {
        const splash = document.getElementById('splash');
        const app = document.getElementById('app');
        
        // Ocultar splash con transición
        splash.classList.add('hidden');
        
        // Mostrar aplicación después de un breve delay
        setTimeout(() => {
            app.classList.add('visible');
        }, 500);
        
        // Cargar datos del sistema
        loadMyInfo();
        loadQSOs();
        initSelectAll();
    }

    const STORAGE_KEY_LOG = 'hamlog_qsos_v2';
    const STORAGE_KEY_INFO = 'hamlog_myinfo_v1';

    let qsos = [];
    let editingIndex = null;

    function loadMyInfo() {
        const raw = localStorage.getItem(STORAGE_KEY_INFO);
        if (!raw) return;
        try {
            const info = JSON.parse(raw);
            if (info.myCall) document.getElementById('myCall').value = info.myCall;
            if (info.myEmail) document.getElementById('myEmail').value = info.myEmail;
        } catch(e) {
            console.error(e);
        }
    }

    function getMyInfo() {
        const myCall = document.getElementById('myCall').value.trim();
        const myEmail = document.getElementById('myEmail').value.trim();
        return { myCall, myEmail };
    }

    function saveMyInfo() {
        const info = getMyInfo();
        localStorage.setItem(STORAGE_KEY_INFO, JSON.stringify(info));
        setStatus('Datos de operador guardados en el navegador.');
    }

    function loadQSOs() {
        const raw = localStorage.getItem(STORAGE_KEY_LOG);
        if (!raw) {
            qsos = [];
            renderTable();
            return;
        }
        try {
            qsos = JSON.parse(raw) || [];
        } catch(e) {
            qsos = [];
        }
        renderTable();
    }

    function saveQSOs() {
        localStorage.setItem(STORAGE_KEY_LOG, JSON.stringify(qsos));
    }

    function setStatus(msg) {
        document.getElementById('status').textContent = msg || '';
        if (!msg) return;
        setTimeout(() => {
            const st = document.getElementById('status');
            if (st.textContent === msg) st.textContent = '';
        }, 4000);
    }

    function clearForm() {
        document.getElementById('call').value = '';
        document.getElementById('date').value = '';
        document.getElementById('time').value = '';
        document.getElementById('band').value = '';
        document.getElementById('mode').value = '';
        document.getElementById('rstHis').value = '';
        document.getElementById('freq').value = '';
        document.getElementById('comments').value = '';
    }

    function enterEditMode(index) {
        const q = qsos[index];
        if (!q) return;
        editingIndex = index;

        document.getElementById('call').value = q.call;
        document.getElementById('date').value = q.date;
        document.getElementById('time').value = q.time;
        document.getElementById('band').value = q.band;
        document.getElementById('mode').value = q.mode;
        document.getElementById('rstHis').value = q.rstHis;
        document.getElementById('freq').value = q.freq;
        document.getElementById('comments').value = q.comments;

        document.getElementById('btnAddQSO').disabled = true;
        document.getElementById('btnUpdateQSO').disabled = false;
        document.getElementById('btnCancelEdit').disabled = true;

        highlightEditingRow();
        setStatus('Editando QSO #' + (index + 1));
    }

    function cancelEditMode() {
        editingIndex = null;
        document.getElementById('btnAddQSO').disabled = false;
        document.getElementById('btnUpdateQSO').disabled = true;
        document.getElementById('btnCancelEdit').disabled = true;
        clearForm();
        highlightEditingRow();
        setStatus('Edición cancelada.');
    }

    function highlightEditingRow() {
        const rows = document.querySelectorAll('#logBody tr');
        rows.forEach((tr, idx) => {
            if (idx === editingIndex) {
                tr.classList.add('selected-row');
            } else {
                tr.classList.remove('selected-row');
            }
        });
    }

    function renderTable() {
        const tbody = document.getElementById('logBody');
        tbody.innerHTML = '';
        qsos.forEach((q, idx) => {
            const tr = document.createElement('tr');

            const tdChk = document.createElement('td');
            const chk = document.createElement('input');
            chk.type = 'checkbox';
            chk.className = 'rowSelect';
            chk.dataset.index = idx;
            tdChk.appendChild(chk);
            tr.appendChild(tdChk);

            const tdIndex = document.createElement('td');
            tdIndex.textContent = idx + 1;
            tr.appendChild(tdIndex);

            function addCell(text) {
                const td = document.createElement('td');
                td.textContent = text || '';
                tr.appendChild(td);
            }

            addCell(q.call);
            addCell(q.date);
            addCell(q.time);
            addCell(q.band);
            addCell(q.mode);
            addCell(q.rstHis);
            addCell(q.freq);
            addCell(q.comments);

            const tdEdit = document.createElement('td');
            const btnE = document.createElement('button');
            btnE.textContent = 'Editar';
            btnE.className = 'btn btn-secondary';
            btnE.style.padding = '2px 4px';
            btnE.onclick = () => enterEditMode(idx);
            tdEdit.appendChild(btnE);
            tr.appendChild(tdEdit);

            const tdDel = document.createElement('td');
            const btnD = document.createElement('button');
            btnD.textContent = 'X';
            btnD.className = 'btn btn-danger';
            btnD.style.padding = '2px 4px';
            btnD.onclick = () => deleteOne(idx);
            tdDel.appendChild(btnD);
            tr.appendChild(tdDel);

            tbody.appendChild(tr);
        });
        highlightEditingRow();
    }

    function deleteOne(index) {
        if (!confirm('¿Eliminar este QSO?')) return;
        qsos.splice(index, 1);
        saveQSOs();
        renderTable();
        setStatus('QSO eliminado.');
        if (editingIndex !== null) {
            cancelEditMode();
        }
    }

    function deleteSelected() {
        const checks = Array.from(document.querySelectorAll('.rowSelect'));
        const toDelete = checks.filter(c => c.checked).map(c => parseInt(c.dataset.index, 10));
        if (!toDelete.length) {
            alert('No hay QSOs seleccionados.');
            return;
        }
        if (!confirm('¿Eliminar los QSOs seleccionados?')) return;
        qsos = qsos.filter((_, idx) => !toDelete.includes(idx));
        saveQSOs();
        renderTable();
        setStatus('QSOs seleccionados eliminados.');
        if (editingIndex !== null) {
            cancelEditMode();
        }
    }

    function deleteAll() {
        if (!qsos.length) {
            alert('No hay QSOs para borrar.');
            return;
        }
        if (!confirm('¿ELIMINAR TODOS LOS QSOs?')) return;
        qsos = [];
        saveQSOs();
        renderTable();
        setStatus('Todos los QSOs han sido eliminados.');
        if (editingIndex !== null) {
            cancelEditMode();
        }
    }

    function normalizeTimeToADIF(timeStr) {
        if (!timeStr) return '';
        let t = timeStr.trim();
        t = t.replace(':', '');
        if (t.length === 3) t = '0' + t;   // 930 -> 0930
        if (t.length === 1 || t.length === 2) t = t.padStart(4, '0');
        return t.slice(0, 4);
    }

    function buildADIF(records) {
        const info = getMyInfo();
        let header = 'Neon Log Master V4.4 - Digital Station Log <eoh>\n';

        let lines = records.map(r => {
            let parts = [];
            if (r.call) parts.push('<CALL:' + r.call.length + '>' + r.call.toUpperCase());
            if (r.date) parts.push('<QSO_DATE:8>' + r.date.replace(/-/g, ''));
            const t = normalizeTimeToADIF(r.time);
            if (t) parts.push('<TIME_ON:4>' + t);
            if (r.band) parts.push('<BAND:' + r.band.length + '>' + r.band.toLowerCase());
            if (r.freq) parts.push('<FREQ:' + r.freq.length + '>' + r.freq);
            if (r.mode) parts.push('<MODE:' + r.mode.length + '>' + r.mode.toUpperCase());
            if (r.rstHis) parts.push('<RST_RCVD:' + r.rstHis.length + '>' + r.rstHis);
            if (r.comments) parts.push('<COMMENT:' + r.comments.length + '>' + r.comments);
            
            // Añadir el indicativo del operador (MY_CALL) si está disponible
            if (info.myCall) {
                parts.push('<MY_CALL:' + info.myCall.length + '>' + info.myCall.toUpperCase());
            }
            
            if (info.myEmail) {
                parts.push('<MY_EMAIL:' + info.myEmail.length + '>' + info.myEmail);
            }
            return parts.join(' ') + ' <eor>';
        });
        return header + lines.join('\n') + '\n';
    }

    function downloadADI(records, fileName) {
        if (!records.length) {
            alert('No hay QSOs para exportar.');
            return;
        }
        const content = buildADIF(records);
        const blob = new Blob([content], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName || 'logbook.adi';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        setStatus('Archivo .ADI generado.');
    }

    function exportSelected() {
        const checks = Array.from(document.querySelectorAll('.rowSelect'));
        const indexes = checks.filter(c => c.checked).map(c => parseInt(c.dataset.index, 10));
        if (!indexes.length) {
            alert('No hay QSOs seleccionados para exportar.');
            return;
        }
        const records = indexes.map(i => qsos[i]);
        downloadADI(records, 'seleccionados.adi');
    }

    function exportAll() {
        if (!qsos.length) {
            alert('No hay QSOs para exportar.');
            return;
        }
        downloadADI(qsos, 'todos.adi');
    }

    function addQSO() {
        const call = document.getElementById('call').value.trim();
        const date = document.getElementById('date').value;
        const time = document.getElementById('time').value.trim();
        const band = document.getElementById('band').value.trim();
        const mode = document.getElementById('mode').value.trim();
        const rstHis = document.getElementById('rstHis').value.trim();
        const freq = document.getElementById('freq').value.trim();
        const comments = document.getElementById('comments').value.trim();

        if (!call || !date || !time) {
            alert('Indicativo, fecha y hora son obligatorios.');
            return;
        }

        const qso = {
            call,
            date,
            time,
            band,
            mode,
            rstHis,
            freq,
            comments
        };
        qsos.push(qso);
        saveQSOs();
        renderTable();
        clearForm();
        setStatus('QSO añadido al libro de guardia.');
    }

    function updateQSO() {
        if (editingIndex === null) return;
        const call = document.getElementById('call').value.trim();
        const date = document.getElementById('date').value;
        const time = document.getElementById('time').value.trim();
        const band = document.getElementById('band').value.trim();
        const mode = document.getElementById('mode').value.trim();
        const rstHis = document.getElementById('rstHis').value.trim();
        const freq = document.getElementById('freq').value.trim();
        const comments = document.getElementById('comments').value.trim();

        if (!call || !date || !time) {
            alert('Indicativo, fecha y hora son obligatorios.');
            return;
        }

        qsos[editingIndex] = {
            call,
            date,
            time,
            band,
            mode,
            rstHis,
            freq,
            comments
        };
        saveQSOs();
        renderTable();
        clearForm();
        setStatus('QSO actualizado.');
        cancelEditMode();
    }

    function openQRZ() {
        const call = document.getElementById('call').value.trim();
        if (!call) {
            alert('Primero escribe el indicativo trabajado.');
            return;
        }
        const url = 'https://www.qrz.com/db/' + encodeURIComponent(call);
        window.open(url, '_blank');
    }

    function initSelectAll() {
        const selectAll = document.getElementById('selectAll');
        selectAll.addEventListener('change', () => {
            const checks = document.querySelectorAll('.rowSelect');
            checks.forEach(c => { c.checked = selectAll.checked; });
        });
    }

    // Inicialización
    window.onload = function() {
        // Crear efecto de puntos luminosos
        createGlowDots();
        
        // Configurar botón de acceso
        document.getElementById('accessSystem').onclick = accessSystem;
        
        // Configurar botones del sistema (se activan después de acceder)
        document.getElementById('saveMyInfo').onclick = saveMyInfo;
        document.getElementById('btnAddQSO').onclick = addQSO;
        document.getElementById('btnUpdateQSO').onclick = updateQSO;
        document.getElementById('btnCancelEdit').onclick = cancelEditMode;
        document.getElementById('btnQRZ').onclick = openQRZ;
        document.getElementById('btnDeleteSelected').onclick = deleteSelected;
        document.getElementById('btnDeleteAll').onclick = deleteAll;
        document.getElementById('btnExportSelected').onclick = exportSelected;
        document.getElementById('btnExportAll').onclick = exportAll;

        // Establecer fecha y hora UTC actuales
        const now = new Date();
        const yyyy = now.getUTCFullYear();
        const mm = String(now.getUTCMonth() + 1).padStart(2, '0');
        const dd = String(now.getUTCDate()).padStart(2, '0');
        const hh = String(now.getUTCHours()).padStart(2, '0');
        const mi = String(now.getUTCMinutes()).padStart(2, '0');
        document.getElementById('date').value = yyyy + '-' + mm + '-' + dd;
        document.getElementById('time').value = hh + mi;
    };
</script>

</body>
</html>
